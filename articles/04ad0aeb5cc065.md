---
title: "NestJSã§MySQLã‚’åˆ©ç”¨ã—ãŸGraphQLãªAPIã‚’æ§‹ç¯‰ã—ã¦ã¿ã‚‹"
emoji: "ğŸ˜¼"
type: "tech"
topics: ["graphql", "mysql", "typescript", "nestjs"]
published: true
---

# ã¯ã˜ã‚ã«
NestJSã§MySQLã‚’åˆ©ç”¨ã—ãŸGraphQLãªAPIã‚’æ§‹ç¯‰ã™ã‚‹éš›ã®å‚™å¿˜éŒ²ã«ãªã‚Šã¾ã™ã€‚
ã¨æ€ã£ãŸã‚‰ã€æ‰‹å…ƒã®m1 macã§ã¯Dockerã®mysqlã‚¤ãƒ¡ãƒ¼ã‚¸ãŒarm64ç”¨ãŒãªã„ã‚ˆã†ã§åˆ©ç”¨ã§ããªã‹ã£ãŸãŸã‚ã€**mariaDBã§ä»£ç”¨**ã—ã¦ã„ã¾ã™ã€‚ãŠè©¦ã—ã®éš›ã¯äºˆã‚Dockerã‚’åˆ©ç”¨ã§ãã‚‹ç’°å¢ƒã‚’ã”ç”¨æ„ãã ã•ã„ã€‚

# NestJSã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
https://nestjs.com/

NestJSã¨ã¯TypeScriptã§é–‹ç™ºã•ã‚ŒãŸãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‘ãã®ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚å†…éƒ¨çš„ã«ã¯Expressã‚’ä½¿ã£ã¦å‡¦ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚Fastifyã‚’ã‚³ã‚¢ã«ã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€GraphQLã¨è‹¥å¹²ç›¸æ€§ãŒæ‚ªã„ï¼Ÿã‚ˆã†ãªã®ã§å€‹äººçš„ã«ã¯ã‚‚ã†å°‘ã—æ§˜å­è¦‹ã§ã™ã€‚ã¨ã«ã‹ãTypeScriptå…¨é–‹ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§å„ç¨®ORMã‚„class-validatorãªã©ã¨ã‚‚ç›¸æ€§ãƒãƒ„ã‚°ãƒ³ã§ã™ğŸ˜

ã¾ãšã¯NestJSã®CLIã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ï¼ˆã“ã®ã‚ãŸã‚Šã¯ãŠå¥½ã¿ã§ï¼‰

```bash
$ npm i -g @nestjs/cli
```

CLIã‚’åˆ©ç”¨ã—ã¦æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
ä»Šå›ã¯`todo-app`ã¨ã—ã¦ã¿ã¾ã—ãŸã€‚
æœ€åˆã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ã¨ã—ã¦npmã‹yarnã‚’ä½¿ã†ã‹èã‹ã‚Œã¾ã™ãŒä»Šå›ã¯yarnã§é€²ã‚ã¦ã„ã¾ã™ã€‚

```bash
$ nest new todo-app

? Which package manager would you â¤ï¸  to use? yarn
âœ” Installation in progress... â˜•

ğŸš€  Successfully created project todo-app
ğŸ‘‰  Get started with the following commands:

$ cd todo-app
$ yarn run start
```

æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒçµ‚ã‚ã‚‹ã¨ã€å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã®ã§ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦è©¦ã—ã«èµ·å‹•ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
$ cd todo-app
$ yarn start
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ã€`http://localhost:3000`ã‚’é–‹ã„ã¦ã€ãŠç´„æŸã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°ã¾ãšã¯ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æˆåŠŸã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/309f558593115d74837ccdeb.png)

# DBã®ç”¨æ„
ä»Šå›ã¯DBã¨ã—ã¦mariaDBã‚’Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰åˆ©ç”¨ã—ã¾ã™ã€‚
GUIã®ç®¡ç†ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦adminerã‚‚ã¤ã„ã§ã«ç”¨æ„ã—ã¦ãŠãã¾ã™ã€‚
ãªãŠã€ãƒ†ã‚¹ãƒˆç”¨ã¨ã®ãŸã‚ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã¯è¡Œã£ã¦ã„ã¾ã›ã‚“ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚

```yml:docker-compose.yml
version: '3.8'

services:
  mysql:
    image: mariadb:10.6.1
    command: --default-authentication-plugin=mysql_native_password
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: example
    ports:
      - 3306:3306

  adminer:
    image: adminer
    restart: always
    ports:
      - 8080:8080
```

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ãŸã‚‰Dockerã‚’æ§‹ç¯‰ã€èµ·å‹•ã—ã¾ã™ã€‚
ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ‰‹å…ƒã«ãªã„å ´åˆã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€æ§‹ç¯‰ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚

```bash
$ docker compose up
```

ç„¡äº‹ã«èµ·å‹•ã—ãŸã‚‰å‹•ä½œã‚’ã¿ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
ãƒ–ãƒ©ã‚¦ã‚¶ã§`http://localhost:8080`ã«æ¥ç¶šã—ã¦adminerã®ç®¡ç†ç”»é¢ã‚’é–‹ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/d29b799fd85e1a5aff1dc4d0.png)

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¨®é¡: MySQL
ã‚µãƒ¼ãƒ: mysql
ãƒ¦ãƒ¼ã‚¶å: root
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: example
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ç©ºç™½

ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚Œã°MySQLãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚
ã‚ã‚ã›ã¦ä»Šå›åˆ©ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹`todo`ã‚’ä½œæˆã—ã¦ãŠãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/3fdfa16d90ef6a1ed71920fa.png)

![](https://storage.googleapis.com/zenn-user-upload/a264149fd1b63408dee8b7e0.png)

# NestJSã®åˆæœŸè¨­å®š

NestJSã§`.env`ãªã©ã®ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸`@nestjs/config`ã‚’ã‚¤ãƒ³ã‚¹ãƒ¼ãƒ«ã—ã¦ãŠãã¾ã™ã€‚ï¼ˆã™ã¿ã¾ã›ã‚“ä»Šå›ã®è¨˜äº‹å†…ã§ã¯çµå±€åˆ©ç”¨ã—ã¾ã›ã‚“ã§ã—ãŸã€‚ã€‚ï¼‰

```bash
$ yarn add @nestjs/config
```

`app.module.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã‚’è¿½è¨˜ã™ã‚‹ã“ã¨ã§ã€`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã—ãŸæƒ…å ±ã‚’`process.env`ç’°å¢ƒå¤‰æ•°çµŒç”±ã§å–å¾—å¯èƒ½ã§ã™ã€‚

```typescript:src/app.module.ts
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { ConfigModule } from '@nestjs/config'; // è¿½åŠ 

@Module({
  imports: [ConfigModule.forRoot()], // è¿½åŠ 
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

# TypeORMã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

TypeScriptè£½ORMã§ã‚ã‚‹TypeORMã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
ä»Šå›ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯mariaDBã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€`mysql`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚ã‚ã‚ã›ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
$ yarn add typeorm @nestjs/typeorm mysql
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ¥ç¶šã«å¿…è¦ã«ãªã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
`synchronize`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯`entities`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹ã”ã¨ã«DBã®æ§‹é€ ã‚’è‡ªå‹•çš„ã«å¤‰æ›´ã—ã¦ãã‚Œã¾ã™ãŒã€æ„å›³ã—ãªã„å¤‰æ›´ã‚’é˜²ããŸã‚ã«ã‚‚é–‹ç™ºç’°å¢ƒã§ã®ã¿`true`ã¨ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³åˆ©ç”¨ã‚’è¡Œã†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã§ã¯åˆ¥é€”ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€å½¢ã«ã™ã‚‹ã®ãŒç†æƒ³ã‹ã¨æ€ã„ã¾ã™ã€‚

```typescript:ormconfig.json
{
  "type": "mysql",
  "host": "localhost",
  "port": 3306,
  "username": "root",
  "password": "example",
  "database": "todo",
  "entities": ["dist/**/entities/*{.ts,.js}"],
  "synchronize": true,
}
```

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶š 

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã™ã‚‹ãŸã‚ã®Moduleãƒ•ã‚¡ã‚¤ãƒ«`src/database/database.module.ts`ã‚’ä½œæˆã—ã¾ã™ã€‚
NestJSã«ã¯Moduleã‚„Controllerãªã©ã‚’CLIã§ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã€ä¾å­˜é–¢ä¿‚ã‚‚è‡ªå‹•çš„ã«è¿½è¨˜ã—ã¦ãã‚Œã‚‹ä¸Šã«ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§ä½œæˆã—ã¦ãã‚Œã¾ã™ã€‚

```bash:nest g ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§
â”‚ name          â”‚ alias       â”‚ description                                  â”‚
â”‚ application   â”‚ application â”‚ Generate a new application workspace         â”‚
â”‚ class         â”‚ cl          â”‚ Generate a new class                         â”‚
â”‚ configuration â”‚ config      â”‚ Generate a CLI configuration file            â”‚
â”‚ controller    â”‚ co          â”‚ Generate a controller declaration            â”‚
â”‚ decorator     â”‚ d           â”‚ Generate a custom decorator                  â”‚
â”‚ filter        â”‚ f           â”‚ Generate a filter declaration                â”‚
â”‚ gateway       â”‚ ga          â”‚ Generate a gateway declaration               â”‚
â”‚ guard         â”‚ gu          â”‚ Generate a guard declaration                 â”‚
â”‚ interceptor   â”‚ in          â”‚ Generate an interceptor declaration          â”‚
â”‚ interface     â”‚ interface   â”‚ Generate an interface                        â”‚
â”‚ middleware    â”‚ mi          â”‚ Generate a middleware declaration            â”‚
â”‚ module        â”‚ mo          â”‚ Generate a module declaration                â”‚
â”‚ pipe          â”‚ pi          â”‚ Generate a pipe declaration                  â”‚
â”‚ provider      â”‚ pr          â”‚ Generate a provider declaration              â”‚
â”‚ resolver      â”‚ r           â”‚ Generate a GraphQL resolver declaration      â”‚
â”‚ service       â”‚ s           â”‚ Generate a service declaration               â”‚
â”‚ library       â”‚ lib         â”‚ Generate a new library within a monorepo     â”‚
â”‚ sub-app       â”‚ app         â”‚ Generate a new application within a monorepo â”‚
â”‚ resource      â”‚ res         â”‚ Generate a new CRUD resource                 â”‚
```

Moduleãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
$ nest g mo database
```

ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¾ã™ã€‚

```typescript:src/database/database.module.ts
import { Module } from '@nestjs/common';
import { Connection } from 'typeorm';
import { TypeOrmModule } from '@nestjs/typeorm';

@Module({
  imports: [TypeOrmModule.forRoot()],
})
export class DatabaseModule {
  constructor(connection: Connection) {
    if (connection.isConnected) {
      console.log('DB connected!');
    }
  }
}
```

ã“ã“ã¾ã§æº–å‚™ã—ãŸã¨ã“ã‚ã§é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦DBã¸ã®æ¥ç¶šãŒã§ãã¦ã„ã‚‹ã‹è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
$ yarn start:dev # :devã‚’ã¤ã‘ã‚‹ã“ã¨ã§watchãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã™
```

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«`DB connected!`ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°æ¥ç¶šã«æˆåŠŸã—ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/b67be3a0e06b771329efbf09.png)

ãªãŠã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ä¸‹è¨˜ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã—ã¾ã£ãŸå ´åˆã¯ã€adminerã§todoãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã§ãã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚

```bash
Error: ER_BAD_DB_ERROR: Unknown database 'todo'
```

# GraphQLã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

GraphQLã®åˆ©ç”¨ã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
$ yarn add @nestjs/graphql graphql-tools graphql apollo-server-express
```

CLIã§Moduleã€Resolverã€Serviceãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
$ nest g mo todos 
$ nest g r todos 
$ nest g s todos 
```

ä¸€æ—¦å‹•ä½œãƒ†ã‚¹ãƒˆã®ãŸã‚Resolverã«ä»®ã®å‡¦ç†ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

```typescript:src/todos/todos.resolver.ts
import { Query, Resolver } from '@nestjs/graphql';
import { TodosService } from './todos.service';

@Resolver()
export class TodosResolver {
  constructor(private todosService: TodosService) {}

  @Query(() => String)
  public async todos() {
    return 'All todos';
  }
}
```

ä½œæˆã—ãŸTodosModuleã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸGraphQLModuleã‚’app.module.tsã«èª­ã¿è¾¼ã¿ã¾ã™ã€‚

```typescript:src/app.module.ts
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { ConfigModule } from '@nestjs/config';
import { DatabaseModule } from './database/database.module';
import { GraphQLModule } from '@nestjs/graphql';
import { TodosModule } from './todos/todos.module';

@Module({
  imports: [
    ConfigModule.forRoot(),
    DatabaseModule,
    GraphQLModule.forRoot({
      playground: true,
      debug: true,
      // ä¸‹è¨˜ã«è¨­å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«åã§ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ãŒæ›¸ãå‡ºã•ã‚Œã¾ã™
      autoSchemaFile: 'schema.graphql', 
    }),
    TodosModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

å„ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ãŒã§ãã¦ã¨ã“ã‚ã§`http://localhost:3000/graphql`ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦GraphQL PlaygroundãŒèµ·å‹•ã™ã‚‹ã‹è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
å·¦å´ã«ä¸‹è¨˜ã‚¯ã‚¨ãƒªãƒ¼ã‚’å…¥åŠ›ã—ã¦All todosã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿”ã£ã¦ãã‚Œã°æ¥ç¶šæˆåŠŸã§ã™ã€‚

```graphql
query {
  todos
}
```

![](https://storage.googleapis.com/zenn-user-upload/925786ef6eeeedf6ac73b7d8.png)

# TODO Modelã®ä½œæˆ
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ ¼ç´ã•ã‚Œã‚‹TODOã®Modelã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚
ä»Šå›ã¯Entityã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«Modelã‚’ç”¨æ„ã—ã¾ã™ã€‚
ä»Šå›ã¯å˜ç´”ãªé …ç›®ã¨ã—ã¦ã€ä¸‹è¨˜ã‚’ç”¨æ„ã—ã¦ã¿ã¾ã—ãŸã€‚

- id è‡ªå‹•çš„ã«ä»˜ä¸ã•ã‚Œã‚‹æ–‡å­—åˆ—
- name æ–‡å­—åˆ—
- priority æ•°å€¤
- completed çœŸå½å€¤
- createdAt æ—¥æ™‚ï¼ˆè‡ªå‹•æ›´æ–°ï¼‰
- updatedAt æ—¥æ™‚ï¼ˆè‡ªå‹•æ›´æ–°ï¼‰

åˆ©ç”¨ã§ãã‚‹ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ç­‰ã¯TypeORMã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ã‚’å‚ç…§ãã ã•ã„ã€‚

https://typeorm.io/#/entities

```typescript:src/todos/entities/todo.ts
import { Field, ObjectType } from '@nestjs/graphql';
import {
  Column,
  CreateDateColumn,
  Entity,
  PrimaryGeneratedColumn,
  UpdateDateColumn,
} from 'typeorm';

@Entity({ name: 'todos' })
@ObjectType()
export class Todo {
  @PrimaryGeneratedColumn('uuid')
  @Field()
  id: string;

  @Column()
  @Field()
  name: string;

  @Column()
  @Field()
  priority: number;

  @Column()
  @Field()
  completed: boolean;

  @CreateDateColumn()
  @Field()
  createdAt: Date;

  @UpdateDateColumn()
  @Field()
  updatedAt: Date;
}
```

ãªãŠã€é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§Entityãƒ•ã‚¡ã‚¤ãƒ«ã«Modelãƒ‡ãƒ¼ã‚¿ã‚’è¨˜è¼‰ã—ã¦ç·¨é›†ã€ä¿å­˜ã™ã‚‹ãŸã³ã«è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åæ˜ ãŒã•ã‚Œã¦ã„ãã¾ã™ã€‚éƒ½åº¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å¿…è¦ãŒãªã„ã®ã§åŠ¹ç‡ã‚ˆãé–‹ç™ºã‚’é€²ã‚ã‚‰ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/4597c42db7cd535751fa75e3.png)

Moduleãƒ•ã‚¡ã‚¤ãƒ«ã€Serviceãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ä½œæˆã—ãŸTODO Entityã‚’ç´ä»˜ã‘ã¦ã„ãã¾ã™ã€‚

```typescript:src/todos/todos.module.ts
import { Module } from '@nestjs/common';
import { TodosService } from './todos.service';
import { TodosResolver } from './todos.resolver';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Todo } from './entities/todo';

@Module({
  imports: [TypeOrmModule.forFeature([Todo])],
  providers: [TodosService, TodosResolver],
  exports: [TodosService],
})
export class TodosModule {}
```

```typescript:src/todos/todos.service.ts
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Todo } from './entities/todo';

@Injectable()
export class TodosService {
  constructor(
    @InjectRepository(Todo) private todoRepository: Repository<Todo>,
  ) {}

  public async getAllTodos(): Promise<Todo[]> {
    const todos = await this.todoRepository.find({});

    // Nest.jsã«ã¯ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨ã®ã‚¯ãƒ©ã‚¹ãŒã‚ã‚Šãã®1ã¤ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™
    // 
    if (!todos) throw new NotFoundException();

    return todos;
  }
}
```

Resolverã‚’ç·¨é›†ã—ã¦Serviceã§è¨­å®šã—ãŸ`getAllTodos`ã®å®Ÿè¡Œçµæœã‚’è¿”ã™ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```typescript:src/todos/todos/resolver.ts
import { Query, Resolver } from '@nestjs/graphql';
import { Todo } from './entities/todo';
import { TodosService } from './todos.service';

@Resolver()
export class TodosResolver {
  constructor(private todosService: TodosService) {}

  @Query(() => [Todo])
  public async todos(): Promise<Todo[]> {
    return await this.todosService.getAllTodos().catch((err) => {
      throw err;
    });
  }
}
```

ã“ã“ã¾ã§è¨˜è¼‰ã—ãŸã¨ã“ã‚ã§å†åº¦GraphQL Playgroundã‚’åˆ©ç”¨ã—ã¦ã€å‹•ä½œã‚’è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ã¾ã ãƒ‡ãƒ¼ã‚¿ã¯ç©ºãªã®ã§ç©ºã®é…åˆ—ãŒè¿”ã£ã¦ãã‚Œã°æˆåŠŸã§ã™ã€‚

```graphql
query {
  todos {
    id
  }
}
```

![](https://storage.googleapis.com/zenn-user-upload/8150bca6d63270486367b34f.png)

# ã‚¯ã‚¨ãƒªãƒ¼ã®ä½œæˆ
ä¸€è¦§ã®å–å¾—ãŒã§ããŸã¨ã“ã‚ã§æ¬¡ã¯ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãè¾¼ã¿Mutationã‚¯ã‚¨ãƒªãƒ¼ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚
ã¾ãšã‚¯ã‚¨ãƒªãƒ¼ã®å‹æƒ…å ±ã¨ãªã‚‹DTOã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript:src/todos/dto/new-todo.input.ts
import { Field, InputType, Int } from '@nestjs/graphql';

@InputType()
export class NewTodoInput {
  @Field()
  name: string;

  @Field(() => Int)
  priority: number;

  @Field()
  completed: boolean;
}
```

Serviceã¨Resolverã«TODOã®è¿½åŠ ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```typescript:src/todos/todos.service.ts
import {
  Injectable,
  InternalServerErrorException,
  NotFoundException,
} from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { NewTodoInput } from './dto/new-todo.input';
import { Todo } from './entities/todo';

@Injectable()
export class TodosService {
  constructor(
    @InjectRepository(Todo) private todoRepository: Repository<Todo>,
  ) {}

  public async getAllTodos(): Promise<Todo[]> {
    const todos = await this.todoRepository.find({});

    if (!todos) throw new NotFoundException();

    return todos;
  }

  public async addTodo(newTodoData: NewTodoInput): Promise<Todo> {
    const newTodo = this.todoRepository.create(newTodoData);
    await this.todoRepository.save(newTodo).catch((err) => {
      new InternalServerErrorException();
    });
    return newTodo;
  }
}
```

```typescript:src/todos/todos.resolver.ts
import { Args, Mutation, Query, Resolver } from '@nestjs/graphql';
import { NewTodoInput } from './dto/new-todo.input';
import { Todo } from './entities/todo';
import { TodosService } from './todos.service';

@Resolver()
export class TodosResolver {
  constructor(private todosService: TodosService) {}

  @Query(() => [Todo])
  public async todos(): Promise<Todo[]> {
    return await this.todosService.getAllTodos().catch((err) => {
      throw err;
    });
  }

  @Mutation(() => Todo)
  public async addNewTodo(
    @Args('newTodoData') newTodoData: NewTodoInput,
  ): Promise<Todo> {
    return await this.todosService.addTodo(newTodoData).catch((err) => {
      throw err;
    });
  }
}
```

ãã‚Œã§ã¯ãƒ‡ãƒ¼ã‚¿ãŒå•é¡Œãªãæ›¸ãè¾¼ã‚ã‚‹ã‹è©¦ã—ã¦ã¿ã¾ã™ã€‚
`http://localhost:3000/graphql`ã‚’é–‹ã„ã¦ã€å·¦å´ã«Mutationã‚¯ã‚¨ãƒªãƒ¼ã‚’æ›¸ãè¾¼ã¿å®Ÿè¡Œã—ã¾ã™ã€‚

```graphql
mutation {
  addNewTodo(newTodoData: {
    name: "ç‰›ä¹³ã‚’è²·ã£ã¦ãã‚‹",
    priority: 1,
    completed: false,
  }) {
    id
    name
    priority
    completed
    createdAt
    updatedAt
  }
}
```

![](https://storage.googleapis.com/zenn-user-upload/1519b44caf3cf8522e67e4c9.png)

çµæœæŠ•ç¨¿ã—ãŸãƒ‡ãƒ¼ã‚¿ã«idã¨createdAtã€updatedAtãŒè‡ªå‹•çš„ã«è¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒè¿”ã£ã¦ãã‚Œã°ç™»éŒ²å®Œäº†ã§ã™ã€‚
å¿µã®ç‚ºä¸€è¦§ã®å–å¾—ã¨adminerã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä¸­èº«ã‚‚ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/07946fc13a153b97939234cb.png)

![](https://storage.googleapis.com/zenn-user-upload/5352a9578c755fe30524d67e.png)

# ã•ã„ã”ã«
ã“ã‚Œã§ä¸€è¦§ã®å–å¾—ã¨TODOã®æŠ•ç¨¿ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
åŒã˜ç”¨ã«æ›´æ–°ã‚„å‰Šé™¤ã‚’è¿½åŠ ã—ã¦ã„ãã“ã¨ã§GraphQLã‚’åˆ©ç”¨ã—ãŸç°¡å˜ãªCRUD APIãŒå®Œæˆã—ã¾ã™ã€‚

å€‹äººçš„ã«ã¯MongoDBã¨ã®çµ„ã¿åˆã‚ã›ãŒå¥½ã¿ã§ã¯ã‚ã‚Šã¾ã™ãŒã€è‡ªåˆ†ã®ç’°å¢ƒã ã¨ãªã‹ãªã‹ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã®ç†è§£ã‚’å¾—ã‚‰ã‚Œãªã„ã®ã§é€šã‚Šã‚„ã™ã„MySQLï¼ˆmariaDBï¼‰ã‚’æƒ³å®šã—ãŸã‚‚ã®ã«ã—ã¦ã¿ã¾ã—ãŸğŸ˜…

ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚„å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®åŠ å·¥ãªã©ã¾ã ã¾ã æ©Ÿèƒ½ã¨ã—ã¦ã¯è¶³ã‚Šã¦ã„ãªã„ã‚‚ã®ã°ã‹ã‚Šã§ã™ãŒã€
`class-validator`ã€`class-transformer`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’åˆ©ç”¨ã—ã¦ç°¡å˜ã«å®Ÿè£…ã—ã¦ã„ãã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

https://www.npmjs.com/package/class-validator

```bash
$yarn add class-validator class-transformer
```

```typescript:src/todos/dto/new-todo.input.ts
import { Field, InputType, Int } from '@nestjs/graphql';
import { IsString, Length } from 'class-validator';

@InputType()
export class NewTodoInput {
  @Field()
  @IsString() // æ–‡å­—åˆ—ã«åˆ¶é™ã™ã‚‹
  @Length(5, 140, { message: '5æ–‡å­—ä»¥ä¸Š140æ–‡å­—ä»¥å†…ã§ã™' }) // æœ€ä½5æ–‡å­—ã€æœ€é•·140æ–‡å­—
  name: string;

  @Field(() => Int)
  priority: number;

  @Field()
  completed: boolean;
}
```

`main.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã«GlobalPipesã‚’è¿½åŠ 

```typescript:src/main.ts
import { ValidationPipe } from '@nestjs/common'; // è¿½åŠ 
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.useGlobalPipes(new ValidationPipe()); // è¿½åŠ 
  app.enableCors();
  // await app.listen(3000);
  // ä»–ã®ãƒ›ã‚¹ãƒˆã‹ã‚‰å‚ç…§ã—ãŸã„å ´åˆã¯0.0.0.0ã‚’è¿½è¨˜
  await app.listen(3000, '0.0.0.0');
}
bootstrap();
```

# ãŠã¾ã‘

NestJSã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯Expressã‚’ã‚³ã‚¢ã¨ã—ã¦å‹•ä½œã—ã¾ã™ãŒã€ã‚ˆã‚Šé«˜é€Ÿã«å‹•ä½œã™ã‚‹Fastifyã‚’ã‚³ã‚¢ã¨ã—ã¦å‹•ä½œã•ã›ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚apollo-server-fastifyãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã¾ã previewç‰ˆã®ãŸã‚ãã®ç‚¹ã ã‘ã”æ³¨æ„ãã ã•ã„ã€‚

```bash
$ yarn add @nestjs/platform-fastify apollo-server-fastify@3.0.0-preview.3
```

```typescript:src/main.ts
import { ValidationPipe } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import {
  FastifyAdapter,
  NestFastifyApplication,
} from '@nestjs/platform-fastify';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create<NestFastifyApplication>(
    AppModule,
    new FastifyAdapter(),
  );
  app.useGlobalPipes(new ValidationPipe());
  app.enableCors();
  // await app.listen(3000);
  // ä»–ã®ãƒ›ã‚¹ãƒˆã‹ã‚‰å‚ç…§ã—ãŸã„å ´åˆã¯0.0.0.0ã‚’è¿½è¨˜
  await app.listen(3000, '0.0.0.0');
}
bootstrap();
```

```bash
# yarn start:dev
```

`http://localhost:3000/graphql`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨IDEã¨ã—ã¦æœ€æ–°ç‰ˆã®Apollo SandboxãŒèµ·å‹•ã—ã¾ã™ã€‚ã‚¹ã‚­ãƒ¼ãƒã¨é€£æºã—ã¦ã‚¯ã‚¨ãƒªã®å…¥åŠ›ãŒã‹ãªã‚Šä¾¿åˆ©ã«ãªã£ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/b44b2f7250cf5fccf7dc885c.png)

https://github.com/himorishige/nestjs-todo-sample