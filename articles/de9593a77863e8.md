---
title: "Redux Toolkit ã®éåŒæœŸå‡¦ç†ã®å¤‰é·ã‚’è©¦ã—ã¦ã¿ã‚‹"
emoji: "ğŸ™ˆ"
type: "tech"
topics: ["react", "typescript", "reduxtoolkit", "mockserviceworker"]
published: true
---

# ã¯ã˜ã‚ã«

Reduxã«ã¯ãªãŒãƒ¼ã„æ­´å²ã®ä¸­ã€éåŒæœŸå‡¦ç†ã«ã¤ã„ã¦ã¯ã„ã‚ã„ã‚ã¨èªã‚‰ã‚Œã¦ãã¾ã—ãŸãŒã€ã€ğŸ™ˆ
Redux Toolkit v1.5.0ã‹ã‚‰ã¯æ–°ãŸãªéåŒæœŸå‡¦ç†ã§ã‚ã‚‹RTK QueryãŒçµ„ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚

RTK Queryã¯swrã‚„react-queryã¨åŒã˜ã‚ˆã†ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’é§†ä½¿ã—ãŸRedux Toolkitãƒãƒ¼ãƒ è¬¹è£½ã®Queryãƒ„ãƒ¼ãƒ«ã¨ãªã£ã¦ã„ã¾ã™ã€‚

https://redux-toolkit.js.org/rtk-query/overview

ã„ãã¤ã‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚ä½¿ã„å§‹ã‚ã¦ã„ãŸã¨ã“ã‚ã§ã™ãŒã€ã¡ã‚‡ã†ã©Redux Thunk -> createAsyncThunk -> RTK Queryã®æ›¸ãæ–¹ã®å¤‰é·ã‚’æ›¸ã„ã¦ã„ã‚‹è¨˜äº‹ã‚’è¦‹ã¤ã‘ãŸã®ã§ã€å‹•ä½œã®å‚è€ƒã«ãªã‚‹ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã¿ã¾ã—ãŸã€‚

https://medium.com/innoventes/rtk-query-redux-redefined-9a9621fbcee

ã‚ã€ã§ã‚‚Redux Thunkã¯çœç•¥ã§ã™ğŸ§Ÿâ€â™‚ï¸

:::message
21.08.14 è¨˜äº‹å†…ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚„ã‚¨ãƒ©ãƒ¼ã®åˆ†å²ã‚’è¿½åŠ ã—ã¾ã—ãŸ
:::

https://github.com/himorishige/rtk-sample

# ãŠè©¦ã—ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

Reactç’°å¢ƒã‚’create-react-appã®redux-typescriptãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ä½œæˆã—ã¾ã™ã€‚

```bash
$ yarn create react-app rtk-query-sample --template redux-typescript
$ cd rtk-query-sample
$ yarn start
```

ãƒ¢ãƒƒã‚¯APIæ¥ç¶šç”¨ã«axiosã¨Mock Service Workerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
RTK Queryã«ã¯axiosã‚„fetchã¯ä¸è¦ã§ã™ãŒã€createAsyncThunkã§åˆ©ç”¨ã—ã¾ã™ã€‚

```bash
$ yarn add axios msw
```

# ãƒ¢ãƒƒã‚¯APIã®ç”¨æ„

ä»Šå›ã¯ãƒ€ãƒŸãƒ¼ã®APIãŒã‚ã‚Œã°ååˆ†ãªã®ã§ã€ãƒ†ã‚¹ãƒˆã§ã‚‚å¤§æ´»èºãªMock Service Workerã‚’ä½¿ã£ã¦ãƒ¢ãƒƒã‚¯APIã‚’ä½œæˆã—ã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã‚’æƒ³å®šã—ãŸãƒ¢ãƒƒã‚¯APIã‚’ç”¨æ„ã—ãŸã„ãŸã‚ã€`/login`ã«å¯¾ã—ã¦POSTã™ã‚‹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿”ã™ã¨ã„ã†æƒ³å®šã§ã™ã€‚

ã¾ãšæœ€åˆã«Sevice Workerã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®Service Workerãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­ç½®ã™ã‚‹ãŸã‚ã«CLIã‚’åˆ©ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

https://mswjs.io/docs/cli/init

```bash
$ npx msw init ./public --save
```

`/public/mockServiceWorker.js`ãŒç”Ÿæˆã•ã‚Œã€`package.json`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¸‹è¨˜ãŒè¿½è¨˜ã•ã‚Œã¾ã™ã€‚

```json:package.json
  "msw": {
    "workerDirectory": "public"
  }
 ```

APIã®å‹•ä½œã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
`create-react-app`ã§ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜ã—ã¦ã„ãã¾ã™ã€‚

https://mswjs.io/docs/api/setup-worker

```typescript:/src/index.tsx
import React from 'react';
import ReactDOM from 'react-dom';
import './index.css';
import App from './App';
import { store } from './app/store';
import { Provider } from 'react-redux';
import * as serviceWorker from './serviceWorker';
import { rest, setupWorker } from 'msw';  // è¿½åŠ 

// ãƒ¢ãƒƒã‚¯APIã‚µãƒ¼ãƒãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
// userNameã«johnãŒå…¥ã£ã¦ã„ã‚‹ã‹å…¥ã£ã¦ã„ãªã„ã‹ã ã‘ã®ç°¡å˜ãªåˆ†å²ãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‚
const mockServer = setupWorker(
  rest.post('/login', (req, res, ctx) => {
    const { userName }: any = req.body;
    if (userName === 'john') {
      return res(
        ctx.delay(2000),
        ctx.status(200),
        ctx.json({
          userName: 'john',
          token: 'token1234',
        }),
      );
    }
    return res(
      ctx.delay(2000),
      ctx.status(401),
      ctx.json({
        message: 'unauthorized',
      }),
    );
  }),
);

mockServer.start();

ReactDOM.render(
  <React.StrictMode>
    <Provider store={store}>
      <App />
    </Provider>
  </React.StrictMode>,
  document.getElementById('root'),
);

// If you want your app to work offline and load faster, you can change
// unregister() to register() below. Note this comes with some pitfalls.
// Learn more about service workers: https://bit.ly/CRA-PWA
serviceWorker.unregister();
```

# createAsyncThunkã®ç”¨æ„

`createAsyncThunk`ã‚’åˆ©ç”¨ã—ãŸSliceã‚’`authSlice.ts`ã¨ã—ã¦ç”¨æ„ã—ã¾ã™ã€‚

```typescript:/src/features/auth/authSlice.ts
import { createAsyncThunk, createSlice, PayloadAction } from '@reduxjs/toolkit';
import { RootState } from '../../app/store';
import axios, { AxiosRequestConfig } from 'axios';

interface LoginForm {
  userName: string;
  password: string;
}

interface UserState {
  userName: string | undefined;
  token: string | undefined;
}

export interface AuthState {
  user: UserState | undefined;
  status: 'idle' | 'loading' | 'failed';
}

const initialState: AuthState = {
  user: undefined,
  status: 'idle',
};

export const loginAsync = createAsyncThunk(
  'auth/login',
  async (loginForm: LoginForm, { rejectWithValue }) => {
    const config: AxiosRequestConfig = {
      headers: {
        'Content-type': 'application/json',
      },
    };

    try {
      const result = await axios.post('/login', loginForm, config);

      return result.data;
    } catch (error: any) {
      if (!error.response) {
        throw error;
      }
      return rejectWithValue(error.response.data);
    } finally {
    }
  },
);

export const authSlice = createSlice({
  name: 'auth',
  initialState,
  reducers: {},
  extraReducers: (builder) => {
    builder
      .addCase(loginAsync.pending, (state) => {
        state.status = 'loading';
      })
      .addCase(loginAsync.fulfilled, (state, action: PayloadAction<UserState>) => {
        state.status = 'idle';
        state.user = action.payload;
      })
      .addCase(loginAsync.rejected, (state) => {
        state.status = 'idle';
      });
  },
});

export const selectLoadingStatus = (state: RootState) => state.auth.status;

export default authSlice.reducer;
```

# RTK Queryã®ç”¨æ„

`RTK Query`ã‚’åˆ©ç”¨ã—ãŸSliceã‚’`rtkAuthSlice.ts`ã¨ã—ã¦ç”¨æ„ã—ã¾ã™ã€‚

```typescript:/src/features/rtk-auth/rtkAuthSlice.ts
import { createSlice, PayloadAction } from '@reduxjs/toolkit';
import { createApi, fetchBaseQuery } from '@reduxjs/toolkit/query/react';

interface LoginForm {
  userName: string;
  password: string;
}

interface UserState {
  userName: string | undefined;
  token: string | undefined;
}

export interface AuthState {
  user: UserState | undefined;
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã¯RTK Queryã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã§ç®¡ç†
  // status: 'idle' | 'loading' | 'failed';
}

const initialState: AuthState = {
  user: undefined,
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã¯RTK Queryã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã§ç®¡ç†
  // status: 'idle',
};

export const authApi = createApi({
  baseQuery: fetchBaseQuery({ baseUrl: '/' }),
  endpoints: (builder) => ({
    login: builder.mutation<UserState, LoginForm>({
      query: (credentials) => ({
        url: 'login',
        method: 'POST',
        body: credentials,
      }),
    }),
  }),
});

export const { useLoginMutation } = authApi;

export const rtkAuthSlice = createSlice({
  name: 'rtk-auth',
  initialState,
  reducers: {},
  extraReducers: (builder) => {
    builder
      // createAsyncThunkã¨é•ã„addMatcherã§æˆåŠŸå¤±æ•—ã®çŠ¶æ…‹ã‚’å–å¾—å¯èƒ½ã§ã™ã€‚
      /** RTK Queryã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ã§ãã‚‹ã®ã§ã€
       * ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®å–å¾—ã®ãŸã‚ã ã‘ã®åˆ©ç”¨ã§ã‚ã‚Œã°ä¸è¦ã ã¨æ€ã„ã¾ã™ã€‚
       */
      // .addMatcher(authApi.endpoints.login.matchPending, (state) => {
      //   state.status = 'loading';
      // })
      .addMatcher(
        authApi.endpoints.login.matchFulfilled,
        (state, action: PayloadAction<UserState>) => {
          // state.status = 'idle';
          state.user = action.payload;
        },
      );
    // .addMatcher(authApi.endpoints.login.matchRejected, (state) => {
    //   state.status = 'idle';
    // });
  },
});

export default rtkAuthSlice.reducer;
```

# Storeã®ç”¨æ„

```typescript:/src/app/store.ts
import { configureStore, ThunkAction, Action } from '@reduxjs/toolkit';
import counterReducer from '../features/counter/counterSlice';
import authReducer from '../features/auth/authSlice';
import rtkAuthReducer, { authApi } from '../features/rtk-auth/RtkAuthSlice';

export const store = configureStore({
  reducer: {
    counter: counterReducer,
    // createAsyncThunkã®Reducer
    auth: authReducer,
    // RTK Queryã®Reducer
    rtkauth: rtkAuthReducer,
    // RTK Queryã®createApiãŒç”Ÿæˆã™ã‚‹Reducerï¼ˆä»Šå›ã¯åˆ©ç”¨ã›ãšï¼‰
    [authApi.reducerPath]: authApi.reducer,
  },
  // RTK Queryç”¨ã®å„ç¨®ä¾¿åˆ©æ©Ÿèƒ½ã‚’middlewareã¨ã—ã¦ç™»éŒ²ï¼ˆä»Šå›ã¯åˆ©ç”¨ã›ãšï¼‰
  middleware: (getDefaultMiddleware) => getDefaultMiddleware().concat(authApi.middleware),
});

export type AppDispatch = typeof store.dispatch;
export type RootState = ReturnType<typeof store.getState>;
export type AppThunk<ReturnType = void> = ThunkAction<
  ReturnType,
  RootState,
  unknown,
  Action<string>
>;
```

# ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ç”¨æ„

ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã ã‘ã§ä»–ã«ãªã«ã‚‚ãªã„ãƒšãƒ¼ã‚¸ã§ã™ã€‚ã€‚

![](https://storage.googleapis.com/zenn-user-upload/2fd4f512c80c9a5d32ca7e17.png)

```typescript:/src/App.tsx
import React, { useState } from 'react';
import { useAppDispatch, useAppSelector } from './app/hooks';
import { loginAsync, selectLoadingStatus } from './features/auth/authSlice';
import { useLoginMutation } from './features/rtk-auth/RtkAuthSlice';

function App() {
  const [userName, setUserName] = useState('');

  const inputHandler = (event: React.ChangeEvent<HTMLInputElement>) => {
    setUserName(event.target.value);
  };

  // CreateAsyncThunkã§ã®åˆ¶å¾¡

  // CreateAsyncThunkã«ã¯dispatchãŒå¿…è¦
  const dispatch = useAppDispatch();
  // loadingã®çŠ¶æ…‹ã‚’å–å¾—
  const loadingStatus = useAppSelector(selectLoadingStatus);

  const loginHandler = async () => {
    const result = await dispatch(
      loginAsync({
        userName: userName,
        password: 'pass1234',
      }),
    );
    // ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ãŸå ´åˆ
    if (loginAsync.fulfilled.match(result)) {
      alert('loginã«æˆåŠŸã—ã¾ã—ãŸ');
    }
    // ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ãŸå ´åˆ
    if (loginAsync.rejected.match(result)) {
      alert('loginã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  };

  // RTKQueryã§ã®åˆ¶å¾¡

  // RTK Queryã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ãŒç”Ÿæˆã•ã‚Œã‚‹
  // result, error, isUnititialized, isLoading, isSuccess, isError
  const [login, { isLoading, isError }] = useLoginMutation();

  const rtkLoginHandler = async () => {
    const data = {
      userName: userName,
      password: 'pass1234',
    };
    try {
      const response = await login(data).unwrap();
      alert('loginã«æˆåŠŸã—ã¾ã—ãŸ');
    } catch (error) {
      alert('loginã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  };

  return (
    <div className="App">
      <input
        type="text"
        name="userName"
        placeholder="john"
        value={userName}
        onChange={inputHandler}
      />
      <hr />
      <div>
        <button type="button" onClick={loginHandler}>
          CreateAsyncThunk LOGIN
        </button>
        {loadingStatus === 'loading' ? (
          <div>loading...</div>
        ) : loadingStatus === 'failed' ? (
          <div>failed...</div>
        ) : null}
      </div>
      <hr />
      <div>
        <button type="button" onClick={rtkLoginHandler}>
          RTK LOGIN
        </button>
        {isLoading ? <div>loading...</div> : isError ? <div>failed...</div> : null}
      </div>
    </div>
  );
}

export default App;
```

# å‹•ä½œç¢ºèª

ã“ã‚Œã§æº–å‚™ã¯ã§ããŸã®ã§èµ·å‹•ã—ã¦ã¿ã¾ã™ã€‚

```bash
$ yarn start
```

![](https://storage.googleapis.com/zenn-user-upload/148d1128ce9d0006dae2e51d.png)

åˆæœŸã®Stateã¯ã“ã®ã‚ˆã†ãªçŠ¶æ…‹ã§ã™ã€‚

Inputã‚¨ãƒªã‚¢ã«johnã¨å…¥åŠ›ã—ã¦ã€
CreateAsyncThunk LOGINãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€2ç§’é–“loading...ã¨è¡¨ç¤ºã•ã‚ŒãŸå¾Œã«Reduxã®Storeã«ãƒ‡ãƒ¼ã‚¿ãŒæ ¼ç´ã•ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/b6742fe9f761b01a6602b0df.gif)

![](https://storage.googleapis.com/zenn-user-upload/2b134e14876b36ed3232e5db.png)

åŒã˜ç”¨ã«RTK LOGINãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€

![](https://storage.googleapis.com/zenn-user-upload/31124463040bf4c40fcf8666.gif)

![](https://storage.googleapis.com/zenn-user-upload/a4aff1d961ca0e2165e38078.png)

ãã‚Œãã‚Œã€Pendingã®çŠ¶æ…‹ã‚’çµŒã¦fullfilledã«ãªã£ãŸã¨ã“ã‚ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒˆãƒ¼ã‚¯ãƒ³ã®æƒ…å ±ãŒå…¥ã‚Šã¾ã—ãŸã€‚

æœ€çµ‚çš„ãªStateã¨ã—ã¦ã¯ã©ã¡ã‚‰ã‚‚åŒã˜ã«ãªã‚Šã¾ã™ãŒã€ã‚½ãƒ¼ã‚¹ã®è¨˜è¼‰ã¯ã‹ãªã‚Šç•°ãªã£ã¦ã„ã¾ã™ã€‚
RTK Queryã‚‚Reduxç‹¬ç‰¹ã®è¨˜è¼‰ãŒå¤šãè¨˜è¼‰é‡ãŒå°‘ãªããªã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã«ã‚ˆã‚‹ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæ¥½ã«ãªã‚‹ãŸã‚ãƒ•ãƒ­ãƒ³ãƒˆå´ã®å‡¦ç†ã¯ã‹ãªã‚Šã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚‹ã¯ãšã§ã™ã€‚ï¼ˆ`App.tsx`å‚ç…§ï¼‰

# ã•ã„ã”ã«

ä»Šå›ã¯ãƒ‡ãƒ¼ã‚¿ã‚’POSTã™ã‚‹ã®ã¿ã§ã—ãŸãŒã€RTK Queryã«ã¯ã€ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒã‚„ãƒãƒ¼ãƒªãƒ³ã‚°ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ãªã©ã‚‚å‚™ã‚ã£ã¦ã„ã‚‹ã®ã§çŠ¶æ…‹ç®¡ç†ã¨ã—ã¦Reduxã‚’åˆ©ç”¨ã™ã‚‹ç’°å¢ƒã§ã®ç›¸æ€§ãŒã‚ˆã„ã®ã¯ã‚‚ã¡ã‚ã‚“DeveloperToolã‚‚ã²ã¨ã¤ã«ã¾ã¨ã¾ã£ã¦ãƒ‡ãƒãƒƒã‚°ã§ãã‚‹ã®ã‚‚ä¾¿åˆ©ã§ã™ã€‚

Redux Toolkitã¯æœ€è¿‘å„ç¨®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚åˆ·æ–°ã—ã€TypeScriptã§ã®èª¬æ˜ã‚„mswã‚’åˆ©ç”¨ã—ãŸæ–°ã—ã„ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚å……å®Ÿã—ã¦ã„ã¾ã™ã€‚Reduxä¸è¦è«–ã‚‚å¤šãèã‹ã‚Œã¾ã™ãŒToolkitã®é€²åŒ–ã§ä½¿ã„ã‚„ã™ãé€²åŒ–ã—ç¶šã‘ã¦ãŠã‚Šã€ã“ã‚Œã‹ã‚‰ã‚‚çŠ¶æ…‹ç®¡ç†ã®ä¸€ã¤ã®é¸æŠè‚¢ã¨ã—ã¦ãœã²ä½¿ã£ã¦ã„ããŸã„ã¨ã“ã‚ã§ã™ã€‚

https://redux-toolkit.js.org/tutorials/overview

https://redux.js.org/usage/writing-tests