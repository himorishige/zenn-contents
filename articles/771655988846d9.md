---
title: "Redux Toolkitã«ã¤ã„ã¦[createEntityAdapteræ¨ã—]"
emoji: "ğŸ‘©â€ğŸ¤"
type: "tech"
topics: ["react", "typescript", "redux"]
published: true
---

# ã¯ã˜ã‚ã«

Reactåˆå­¦è€…ãŒReduxã‚’ä½¿ã†ã«ã¯å­¦ç¿’ã‚³ã‚¹ãƒˆãŒé«˜ã„ã¨è¨€ã‚ã‚Œã¦é¿ã‘ã‚‰ã‚Œã‚‹å‚¾å‘ã«ã‚ã‚‹æ°—ã‚‚ã—ã¾ã™ãŒã€Redux Toolkitã®ç™»å ´ã¨é€²åŒ–ã§æ°—è»½ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ã¦ãã¦ã„ã‚‹ã®ã§ãœã²ä½¿ã£ã¦ã¿ã¦ã»ã—ã„ã¨ã“ã‚ã€‚

ãã®ä¸­ã§ã‚‚æ¨ã—æ©Ÿèƒ½ã€createAsyncThunkã¨createEntityAdapterã«ã¤ã„ã¦ã®ç°¡å˜ãªã”ç´¹ä»‹ã§ã™ã€‚

ã¡ãªã¿ã«æœ€è¿‘v1.6ã‹ã‚‰å‚åŠ ã®ãƒ‹ãƒ¥ãƒ¼ãƒ¡ãƒ³ãƒãƒ¼RTK QueryãŒæ¨ã—ãƒ¡ãƒ³ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸğŸ‰

https://zenn.dev/himorishige/articles/9d47f3d8b50342

# Reduxã¨ã¯

Reduxã¯ã€ã€ŒActionã€ã¨å‘¼ã°ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç”¨ã„ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ï¼ˆstateï¼‰ã‚’ç®¡ç†ãƒ»æ›´æ–°ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚Reactä»¥å¤–ã«ã‚‚åˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ãŒReactã¨ã¨ã‚‚ã«ç”¨ã„ã‚‰ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã‚ˆã†ã§ã™ã€‚
Fluxã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã®æ¦‚å¿µã‚’åˆ©ç”¨ã—ã¦è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€ä¸»ã«Actionã€Storeã€Reducerã®è¦ç´ ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

Reactã§ã¯å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒpropã¨stateã‚’æŒã£ã¦ã„ã¾ã™ãŒã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¦æ¨¡ãŒå¤§ãããªã‚Šã«ã¤ã‚Œã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®ã‚„ã‚Šå–ã‚ŠãŒå¤§å¤‰ã«ãªã£ã¦ãã¾ã™ã€‚ä¿—ã«prop drilling problemã¨ã‚‚å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚
Reduxã‚’ç”¨ã„ã‚‹ã¨Storeã¨ã„ã†å”¯ä¸€ã®ç®±ã®ã‚ˆã†ãªã‚‚ã®ã§stateã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã€ã©ã“ã‹ã‚‰ã§ã‚‚æ›´æ–°ã€å‚ç…§ã§ãã‚‹ã¨ã„ã†å¤§ããªãƒ¡ãƒªãƒƒãƒˆã‚’æŒã£ã¦ã„ã¾ã™ã€‚

Reduxã®å¤§ã¾ã‹ãªæµã‚Œã¨ã—ã¦ã¯ã€

- Actionã¯ActionCreatorã§ä½œã‚‰ã‚Œã¾ã™ã€‚
- Storeã§ã¯stateã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚
- Reducerã¯Actionã¨stateã‹ã‚‰æ–°ã—ã„stateã‚’ä½œæˆã—ã¾ã™ã€‚

ã¾ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¡Œã„ãŸã„Actionã‚’ã€Storeã«å¯¾ã—ã¦dispatchã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨ã„ã¦é€ä¿¡ã—ã¾ã™ã€‚
æ¬¡ã«ReducerãŒã€StoreãŒå—ã‘å–ã£ãŸActionã«ã—ãŸãŒã£ã¦stateã‹ã‚‰æ–°ã—ã„stateã‚’ä½œæˆã—ã¦è¿”ã—ã¾ã™ã€‚
å¿…ãšæ–°ã—ã„stateã®ã¿ã‚’è¿”ã™ã“ã¨ã§ã€Reduxã§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸­ã§çŠ¶æ…‹ãŒã„ã¤ã€ã©ã®ã‚ˆã†ã«æ›´æ–°ã•ã‚ŒãŸã‹ã‚’å®¹æ˜“ã«æŠŠæ¡ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c82615219ff7e5abb476b76c.png)

ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ«ãƒ‡ãƒãƒƒã‚®ãƒ³ã‚°ã¨ã‚‚è¨€ã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã€ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ„ãƒ¼ãƒ«ã‚’ç”¨ã„ã‚‹ã¨æ™‚é–“è»¸ã«æ²¿ã£ãŸå‹•ãã‚’ãƒ‡ãƒãƒƒã‚°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ã¯ã¨ã¦ã‚‚æœ‰ç›Šãªåé¢ã€ãƒ«ãƒ¼ãƒ«ãŒå³æ ¼ã§æ‰‹ç¶šãä¸Šè¨˜è¼‰ã™ã‚‹å†…å®¹ã‚‚å†—é•·ã«ãªã‚‹ã“ã¨ã§å­¦ç¿’ã‚³ã‚¹ãƒˆã€é‹ç”¨ã‚³ã‚¹ãƒˆã‚‚ã‹ã‹ã‚‹ãŸã‚æœ€è¿‘ã§ã¯è„±Reduxè«–ã‚‚ã•ã‹ã‚“ã«è­°è«–ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

# Redux Toolkit

ãã‚“ãªä¸­å…¬å¼ã®Redux ToolkitãŒ2019/10ã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸã€‚  
Redux Toolkitã¯Reduxã‚’ã‚ˆã‚Šç°¡æ½”ã«è¨˜è¿°ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å…¬å¼ãƒšãƒ¼ã‚¸ã«æ²è¼‰ã•ã‚Œã¦ã„ã‚‹Redux Style Guideã§ã‚‚Toolkitã®åˆ©ç”¨ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚

https://redux.js.org/style-guide/style-guide

# Redux Toolkitã‚’ä½¿ã†ãƒ¡ãƒªãƒƒãƒˆ

## åˆæœŸè¨­å®šãªã©ãŒã»ã¨ã‚“ã©ä¸è¦ã«ãªã‚‹

Redux DevTools Extensionï¼ˆãƒ‡ãƒãƒƒã‚®ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ï¼‰ã®è¨­å®šã‚„éåŒæœŸé€šä¿¡ã‚’æ‰±ã†ReduxThunkãªã©ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒåŒæ¢±ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€è¨­å®šä¸è¦ã§åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## ã‚³ãƒ¼ãƒ‰é‡ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ•°ï¼Ÿï¼‰ãŒå°‘ãªããªã‚‹

Actionã€ActionCreatorã€ReducerãŒcreateSliceã¨ã„ã†ã²ã¨ã¤ã®è¨˜è¿°ã§ã¾ã¨ã‚ã¦è¨˜è¼‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ¼ãƒ‰è¡Œæ•°ã¯å¢—ãˆã‚‹ã‹ã‚‚ã€‚ã€‚

## stateã®ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã‚’æ„è­˜ãªãã¦ã‚ˆã„

Reducerã®ä¸­ã§æ–°ã—ã„stateã‚’è¿”ã™éš›ã«ã¯å¿…ãšã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªå€¤ã¨ãªã‚‹ã‚ˆã†ã«ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã§ã—ãŸãŒã€Toolkitã§ã¯å†…éƒ¨ã§è‡ªå‹•çš„ã«ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãªå€¤ã¨ã—ã¦å‡¦ç†ã‚’è¡Œã£ã¦ãã‚Œã¾ã™ã€‚

## TypeScriptã®å‹ãŒåŠ¹ã

Toolkitã§ã¯å¤šãã®å‹ãŒè¨­å®šã•ã‚Œã„ã‚‹ã®ã§å‹ã«ã‚ˆã‚‹è£œå®Œã¨åˆ¶å¾¡ã®æ©æµã‚’å—ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
create-react-appã®Reduxãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã†ã¨ãã®ã¾ã¾åˆ©ç”¨ã§ãã‚‹éƒ¨åˆ†ã‚‚å¤šãã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã€‚

https://github.com/reduxjs/cra-template-redux

## createAsyncThunkã¨createEntityAdapterãŒä¾¿åˆ©

Toolkitã®1.3ã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸcreateAsyncThunkã¨createEntityAdapterãŒã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã€‚

## createAsyncThunk

https://redux-toolkit.js.org/api/createAsyncThunk

éåŒæœŸå‡¦ç†ã«å¯¾å¿œã—ãŸActionCreatorã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ã§ã€ä¸‹è¨˜3ç¨®ã®çŠ¶æ…‹ã‚’ç°¡å˜ã«ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- pending: éåŒæœŸå‡¦ç†ä¸­
- fulfilled: éåŒæœŸå‡¦ç†ã®æˆåŠŸæ™‚
- rejected: éåŒæœŸå‡¦ç†ã®å¤±æ•—æ™‚

## createEntityAdapter

https://redux-toolkit.js.org/api/createEntityAdapter

å‹æƒ…å ±ã‚’ã‚‚ã¨ã«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ“ä½œç”¨ã®Adapterã‚’ç”Ÿæˆã—ã€CRUDï¼ˆcreate, read, update, deleteï¼‰æ“ä½œã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ãã‚Œã‚‹é–¢æ•°ã§ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ‰±ã†ã‚ˆã†ãªå½¢ã§å‡¦ç†ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```typescript
{
  id: 1,
  title: 'create-react-appç›´å¾Œã«ã‚„ã‚‹ç’°å¢ƒæ§‹ç¯‰ã®å‚™å¿˜éŒ²',
  createdAt: 1620804168398,
  updatedAt: 1621064460898,
  body: 'æœ¬æ–‡ãƒ†ã‚­ã‚¹ãƒˆ',
  image: '/assets/images/dummy01.jpeg',
  like: 167,
  publish: false
} 
```

ä¾‹ãˆã°ä¸Šè¨˜ã®ã‚ˆã†ãªå½¢å¼ã‚’ä¸‹è¨˜ã®ã‚ˆã†ãªå½¢ã«è‡ªå‹•çš„ã«å¤‰æ›ã—ã¦ç®¡ç†ã—ã¦ãã‚Œã¾ã™ã€‚

```typescript
{
  postsEntity: {
    ids: [
      1,
      2
    ],
    entities: {
      '1': {
        id: 1,
        title: 'create-react-appç›´å¾Œã«ã‚„ã‚‹ç’°å¢ƒæ§‹ç¯‰ã®å‚™å¿˜éŒ²',
        createdAt: 1620804168398,
        updatedAt: 1621064460898,
        body: 'æœ¬æ–‡ãƒ†ã‚­ã‚¹ãƒˆ',
        image: '/assets/images/dummy01.jpeg',
        like: 167,
        publish: false
      },
      '2': {
        id: 2,
        title: 'Reactã‚’ä½¿ã£ãŸãŠå¤©æ°—ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦ã¿ãŸ',
        createdAt: 1620804168398,
        updatedAt: 1621070951011,
        body: 'æœ¬æ–‡ãƒ†ã‚­ã‚¹ãƒˆ2',
        image: '/assets/images/dummy01.jpeg',
        like: 112,
        publish: true
      },
    },
  }
}
```

ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£åŒ–ï¼ˆãƒãƒ¼ãƒãƒ©ã‚¤ã‚ºï¼‰ã«ã¤ã„ã¦ã®ã¯ä¸‹è¨˜ã§ã‚µãƒ³ãƒ—ãƒ«ã‚’ãƒ™ãƒ¼ã‚¹ã«è§£èª¬ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://redux.js.org/recipes/structuring-reducers/normalizing-state-shape

## å®Ÿè£…ä¾‹ 

å°‘ã€…é•·ã„ã®ã§ã™ãŒå®Ÿè£…ã‚’è¡Œã£ãŸã‚µãƒ³ãƒ—ãƒ«ã«ãªã‚Šã¾ã™ã€‚
ã¾ãšã¯ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹å‹æƒ…å ±ã€‚ãƒ–ãƒ­ã‚°ã®æŠ•ç¨¿ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¦ã„ã¾ã™ã€‚

```typescript:src/types/index.ts
export type Post = {
  id: string;
  createdAt: number;
  updatedAt?: number;
  title: string;
  body: string;
  image: string;
  like: number;
  publish: boolean;
};

export type Posts = Post[];
```

ä»¥ä¸‹æŠ•ç¨¿ä¸€è¦§ã®å–å¾—ã‚„æ›´æ–°ã€å‰Šé™¤ã‚’è¡Œã†Sliceã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚

createEntityAdapterã§ä½œæˆã—ãŸAdapterã«å¯¾ã—ã¦ã¯ä¸‹è¨˜ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚

- addOne 1ä»¶è¿½åŠ 
- addMany è¤‡æ•°è¿½åŠ 
- setAll å…¨ä»¶è¿½åŠ ä¸Šæ›¸ã
- removeOne 1ä»¶å‰Šé™¤
- removeMany è¤‡æ•°å‰Šé™¤
- removeAll å…¨ä»¶å‰Šé™¤
- updateOne 1ä»¶ã‚’æ›´æ–°
- updateMany è¤‡æ•°æ›´æ–°
- upsertOne 1ä»¶ã‚’æ›´æ–°ã€å­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ 
- upsertMany è¤‡æ•°ã‚’æ›´æ–°ã€å­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ 

ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚

```typescript:src/features/posts/postsEntitySlice.ts
import {
  createAsyncThunk,
  createEntityAdapter,
  createSlice,
  PayloadAction,
} from '@reduxjs/toolkit';
import { RootState } from 'src/app/store';
import axios from 'axios';

import { Post, Posts } from 'src/types';

export type PostsState = {
  posts: Posts;
  status: 'idle' | 'loading' | 'failed';
  message: string;
};

/**
 * entityç”¨ã®ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚’ç”Ÿæˆ
 */


const postsAdapter = createEntityAdapter<Post>({
  // è¨˜äº‹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸¦ã³é †ã‚’é™é †ã«å¤‰æ›´
  selectId: (post) => post.id,
  sortComparer: (a, b) => {
    if (a.id < b.id) {
      return 1;
    } else {
      return -1;
    }
  },
});

const postInitialEntityState = postsAdapter.getInitialState({
  // å‹ä»¥å¤–ã«è¨­å®šã—ãŸã„ã‚‚ã®ã¯ã“ã“ã§ç”¨æ„
  status: 'idle',
  message: '',
});

// APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
const URL = process.env.REACT_APP_JSON_SERVER_URL || 'http://localhost:3000';

/**
 * æŠ•ç¨¿ä¸€è¦§ã‚’å–å¾—ã™ã‚‹
 */

export const fetchEntityPosts = createAsyncThunk('posts/fetchEntityPosts', async (_, thunkApi) => {
  const response = await axios.get<Posts>(`${URL}/posts`).catch((err) => {
    thunkApi.rejectWithValue(err); // thunkApiã‚’åˆ©ç”¨ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã©ã‚’reducerã«ã‚ãŸã™ã“ã¨ãŒã§ãã‚‹
    throw err;
  });
  return response.data;
});

/**
 * æŠ•ç¨¿ã‚’è¿½åŠ ã™ã‚‹
 */

export const addEntityPost = createAsyncThunk(
  'posts/addEntityPost',
  async (post: Omit<Post, 'id'>, thunkApi) => {
    const response = await axios.post<Post>(`${URL}/posts`, post).catch((err) => {
      thunkApi.rejectWithValue(err);
      throw err;
    });
    return response.data;
  },
);

/**
 * æŠ•ç¨¿ã‚’ç·¨é›†ã™ã‚‹
 */

export const updateEntityPost = createAsyncThunk(
  'posts/updateEntityPost',
  async (post: Post, thunkApi) => {
    const response = await axios.put<Post>(`${URL}/posts/${post.id}`, post).catch((err) => {
      thunkApi.rejectWithValue(err);
      throw err;
    });
    return response.data;
  },
);

/**
 * æŠ•ç¨¿ã‚’å‰Šé™¤ã™ã‚‹
 */

export const deleteEntityPost = createAsyncThunk(
  'posts/deleteEntityPost',
  async (postId: string, thunkApi) => {
    const response = await axios
      .delete<Post>(`${URL}/posts/${postId}`, {
        data: { id: postId },
      })
      .catch((err) => {
        thunkApi.rejectWithValue(err);
        throw err;
      });
    return { data: response.data, postId };
  },
);

/**
 * è©²å½“ã™ã‚‹æŠ•ç¨¿IDã«ã„ã„ã­ã‚’1ãƒ—ãƒ©ã‚¹ã™ã‚‹
 */

export const putLikes = createAsyncThunk('posts/putLikes', async (postData: Post, thunkApi) => {
  const response = await axios
    .put<Post>(`${URL}/posts/${postData.id}`, {
      ...postData,
      like: postData.like + 1,
    })
    .catch((err) => {
      thunkApi.rejectWithValue(err);
      throw err;
    });

  return { id: response.data.id, like: response.data.like };
});

/**
 * å…¬é–‹ãƒ»éå…¬é–‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
 */

export const togglePublish = createAsyncThunk(
  'posts/togglePublish',
  async (postData: Post, thunkApi) => {
    const response = await axios
      .put<Post>(`${URL}/posts/${postData.id}`, {
        ...postData,
        publish: !postData.publish,
      })
      .catch((err) => {
        thunkApi.rejectWithValue(err);
        throw err;
      });
    return { id: response.data.id, publish: response.data.publish };
  },
);

export const postsEntitySlice = createSlice({
  name: 'postsEntity',
  initialState: postInitialEntityState,
  reducers: {},
  extraReducers: (builder) => {
    builder
      .addCase(fetchEntityPosts.pending, (state) => {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­
        state.status = 'loading';
        state.message = '';
      })
      .addCase(fetchEntityPosts.rejected, (state, action) => {
        // å¤±æ•—
        state.status = 'failed';
        if (action.error.message) {
          state.message = action.error.message;
        }
      })
      .addCase(fetchEntityPosts.fulfilled, (state, action) => {
        // æˆåŠŸ
        state.status = 'idle';
        // å–å¾—ã—ãŸæŠ•ç¨¿å…¨ä»¶ã‚’storeã«ç™»éŒ²
        postsAdapter.setAll(state, action.payload);
      })
      .addCase(addEntityPost.pending, (state) => {
        state.status = 'loading';
        state.message = '';
      })
      .addCase(addEntityPost.rejected, (state, action) => {
        state.status = 'failed';
        if (action.error.message) {
          state.message = action.error.message;
        }
      })
      .addCase(addEntityPost.fulfilled, (state, action) => {
        state.status = 'idle';
        // 1ä»¶ã‚’storeã«æ–°è¦ç™»éŒ²
        postsAdapter.addOne(state, action.payload);
      })
      .addCase(updateEntityPost.pending, (state) => {
        state.message = '';
      })
      .addCase(updateEntityPost.rejected, (state, action) => {
        if (action.error.message) {
          state.message = action.error.message;
        }
      })
      .addCase(updateEntityPost.fulfilled, (state, action: PayloadAction<Post>) => {
        state.status = 'idle';
        const { id, ...updateData } = action.payload;
        // 1ä»¶ã‚’idã§æŒ‡å®šã—ã¦æ›´æ–°
        postsAdapter.updateOne(state, {
          id: id,
          changes: { ...updateData },
        });
      })
      .addCase(deleteEntityPost.pending, (state) => {
        state.status = 'loading';
        state.message = '';
      })
      .addCase(deleteEntityPost.rejected, (state, action) => {
        state.status = 'failed';
        if (action.error.message) {
          state.message = action.error.message;
        }
      })
      .addCase(deleteEntityPost.fulfilled, (state, action) => {
        state.status = 'idle';
        postsAdapter.removeOne(state, action.payload.postId);
      })
      .addCase(putLikes.pending, (state) => {
        state.message = '';
      })
      .addCase(putLikes.rejected, (state, action) => {
        if (action.error.message) {
          state.message = action.error.message;
        }
      })
      .addCase(putLikes.fulfilled, (state, action: PayloadAction<{ id: string; like: number }>) => {
        state.status = 'idle';
        // 1ä»¶ã®likeã¨ã„ã†é …ç›®ã®ã¿æ›´æ–°
        postsAdapter.updateOne(state, {
          id: action.payload.id,
          changes: { like: action.payload.like },
        });
      })
      .addCase(togglePublish.pending, (state) => {
        state.message = '';
      })
      .addCase(togglePublish.rejected, (state, action) => {
        if (action.error.message) {
          state.message = action.error.message;
        }
      })
      .addCase(
        togglePublish.fulfilled,
        (state, action: PayloadAction<{ id: string; publish: boolean }>) => {
          // 1ä»¶ã®publishã¨ã„ã†é …ç›®ã®ã¿æ›´æ–°
          state.status = 'idle';
          postsAdapter.updateOne(state, {
            id: action.payload.id,
            changes: { publish: action.payload.publish },
          });
        },
      );
  },
});

export default postsEntitySlice.reducer;

// å…¨ä»¶å–å¾—ç”¨ã®selector
export const selectPosts = postsAdapter.getSelectors<RootState>((state) => state.postsEntity);

// å˜ä¸€é …ç›®å–å¾—ç”¨ã®selector
export const selectStatus = (state: RootState) => state.postsEntity.status;
export const selectMessage = (state: RootState) => state.postsEntity.message;
```

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´ã§ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«åˆ©ç”¨ã§ãã¾ã™ã€‚
ã¾ãŸuseSelectorã‚„useDispatchã«ã¤ã„ã¦ã‚‚ä¸‹è¨˜ã®ã‚ˆã†ã«å‹ã‚’æ‰±ãˆã‚‹å½¢ã§åˆ©ç”¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

```typescript:src/app/hooks.tsï¼ˆreduxãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
import { TypedUseSelectorHook, useDispatch, useSelector } from 'react-redux';
import type { RootState, AppDispatch } from './store';

// Use throughout your app instead of plain `useDispatch` and `useSelector`
export const useAppDispatch = () => useDispatch<AppDispatch>();
export const useAppSelector: TypedUseSelectorHook<RootState> = useSelector;
```

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´ã§ã¯usuSelectorã‹ã‚‰Adapterã«å¯¾ã—ã¦ä¸‹è¨˜ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- selectIds idã®ä¸€è¦§ã‚’é…åˆ—ã§å–å¾—
- selectEntities entitiesã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
- selectAll å…¨ä»¶ã®é…åˆ—ã‚’å–å¾—
- selectTotal ä»¶æ•°ã‚’å–å¾—
- selectById è©²å½“ã™ã‚‹idã«ç´ã¥ããƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

selectAllã¨selectByIdãŒä¸€ç•ªåˆ©ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

```typescript:ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´
// å…¨ä»¶ã‚’å–å¾—
const posts = useAppSelector(selectPosts.selectAll);

// idã‚’æŒ‡å®šã—ã¦å–å¾—
const post = useAppSelector((state) => selectPosts.selectById(state, postId));
```

ã“ã®ã‚ˆã†ãªå½¢ã§ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£åŒ–ã•ã‚ŒãŸã‚‚ã®ã‹ã‚‰ã€æ„è­˜ã›ãšã«é€šå¸¸ã®é…åˆ—ã®å½¢ã«å¤‰æ›ã•ã‚Œã¦å¤‰æ•°ã¸æ ¼ç´ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
ã¾ãŸcreateAsyncThunkã§ã®å®Ÿè¡Œçµæœã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä¸Šã§ã‚‚å‚ç…§ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript:ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´
const resultAction = await dispatch(fetchEntityPosts());
// å¤±æ•—æ™‚ã§ã‚ã‚Œã°rejectedã€
// æˆåŠŸæ™‚ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ™‚ã¯ãã‚Œãã‚Œfullfilledã€pendingã¨matchã•ã›ã‚‹ã“ã¨ã§åˆ¤åˆ¥ãŒå¯èƒ½
if (fetchEntityPosts.rejected.match(resultAction)) {
  alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
}      
```

# ã•ã„ã”ã«
Reduxã«ã¤ã„ã¦ã¯å…¬å¼ã‚µã‚¤ãƒˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæœ€è¿‘å¤§ããã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚èª­ã¿ç›´ã™ãŸã³ã«æ–°ã—ã„æ°—ä»˜ããŒã‚ã‚‹ã®ã§ã€ãœã²å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

# é–¢é€£è¨˜äº‹

https://zenn.dev/himorishige/articles/9d47f3d8b50342
