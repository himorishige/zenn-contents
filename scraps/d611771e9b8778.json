{
  "title": "Remixã§LoaderFunctionã‹ã‚‰loaderHeadersã«ãƒ‡ãƒ¼ã‚¿ãŒæ¸¡ã‚‰ãªã„",
  "closed": true,
  "archived": false,
  "created_at": "2022-02-04",
  "comments": [
    {
      "author": "himorishige",
      "created_at": "2022-02-04",
      "body_markdown": "Remixã§microCMSã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€draftKeyãŒä»˜ä¸ã•ã‚ŒãŸæ™‚ã«headerã‚’å‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆãŸã„ã€‚`loaderHeaders.get('Cache-Control')`ã«ã¯å¿…ãš`null`ãŒå…¥ã£ã¦ã—ã¾ã†ã€‚\n\n```typescript:app/routes/posts/$postId.tsx\n// dataLoaderã‹ã‚‰headerãŒæ¸¡ã•ã‚ŒãŸå ´åˆã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯stale-while-revalidate\nexport const headers: HeadersFunction = ({ loaderHeaders }) => {\n  const cacheControl =\n    loaderHeaders.get('Cache-Control') ??\n    'max-age=0, s-maxage=60, stale-while-revalidate=60';\n  return {\n    'Cache-Control': cacheControl,\n  };\n};\n\n// microCMS APIã‹ã‚‰è¨˜äº‹è©³ç´°ã‚’å–å¾—ã™ã‚‹\nexport const loader: LoaderFunction = async ({ params, request }) => {\n  // ä¸‹æ›¸ãã®å ´åˆ\n  const url = new URL(request.url);\n  const draftKey = url.searchParams.get('draftKey');\n\n  // è¨˜äº‹ã‚’å–å¾—\n\n  // ä¸‹æ›¸ãã®å ´åˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ˜ãƒƒãƒ€ã‚’å¤‰æ›´\n  const headers = draftKey\n    ? { 'Cache-Control': 'no-store, max-age=0' }\n    : undefined;\n\n  return json(content, { headers });\n};",
      "body_updated_at": "2022-02-04"
    },
    {
      "author": "himorishige",
      "created_at": "2022-02-04",
      "body_markdown": "æš«å®šã®è§£æ±ºç­–\n\n`app/root.tsx`ã«`LoaderFunction`ã‚’è¿½åŠ ã€‚\n\nè¦ªã¨ãªã‚‹rootã®loaderã«ä½•ã‹ã—ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‚‚ã—ãã¯æ˜ç¤ºçš„ã«`null`ã§ã‚ã‚Œã°å‡¦ç†ãŒã†ã¾ãã„ã£ã¦ã„ã‚‹æ¨¡æ§˜ã€‚\n\n```typescript:app/root.tsx\nexport const loader: LoaderFunction = async () => {\n  return null;\n};\n```",
      "body_updated_at": "2022-02-04"
    },
    {
      "author": "himorishige",
      "created_at": "2022-02-04",
      "body_markdown": "æš«å®šã®è§£æ±ºç­–ã«è‡³ã‚‹ã¾ã§ã®çµŒç·¯\n\næ¢ã£ã¦ã¿ãŸã¨ã“ã‚åŒã˜ç¾è±¡ã¯ã™ã§ã«ä¸‹è¨˜issueã§å ±å‘Šã•ã‚Œã¦ã„ãŸã€‚\nhttps://github.com/remix-run/remix/issues/1140\n\nãƒ‡ãƒ¼ã‚¿ã®æµã‚Œã¯ä¸‹è¨˜ã®ã‚ˆã†ãªæ„Ÿã˜\n`dataLoader -> middlewareï¼ˆjson helperï¼‰ -> headerLoader`\n\næŒ‡æ‘˜ç®‡æ‰€ã¯`json helper`ã ã£ãŸãŒã€`helper function`ã‚’æ›¸ãæ›ãˆã‚‹ã®ã¯ä»–ã«ã‚‚å½±éŸ¿ã‚ã‚‹ã‹ã¨æ€ã„`dataLoader`å´ã‹ã‚‰è©²å½“ç®‡æ‰€ã‚’å‡ºåŠ›ã™ã‚‹éƒ¨åˆ†ã‚’èª¿æ•´ã™ã‚‹PRã‚’æŠ•ã’ãŸã€‚\n\nhttps://github.com/remix-run/remix/pull/1705\n\né–‹ç™ºè€…ã®ryanflorenceæ°ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã‚‚ã‚‰ã†ãŒã€ryanflorenceæ°ã®ç’°å¢ƒã§ã¯è©²å½“ã®å•é¡Œã¯èµ·ãã¦ã„ãªã„ã¨issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ã—ã¾ã£ãŸã€‚\n\nã„ã‚„ã„ã‚„ã€ã¨ã„ã†ã“ã¨ã§ã€ç—‡çŠ¶ã‚’å†ç¾ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¨codesandboxç’°å¢ƒã‚’ç”¨æ„ã—ãŸã€‚\n\nhttps://codesandbox.io/s/intelligent-sammet-losgp?file=/app/routes/index.tsx\n\næ”¹ã‚ã¦ryanflorenceæ°ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã€‚\n\n> Ah we have regression here, at the moment, headers incorrectly requires that every parent route has a loader. We'll fix this soon, thanks for your work on this :)\n\nã©ã†ã‚„ã‚‰ã€rootã®loaderã‹ã‚‰ã‚‚loaderãŒæ¸¡ã£ã¦ãã‚‹å‰æã§headerLoaderã®ãƒ­ã‚¸ãƒƒã‚¯ãŒçµ„ã¾ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹ã“ã¨ãŒåŸå› ã‚‰ã—ã„ã€‚\n\nã¨ã„ã†ã“ã¨ã§issueã¯å†ã‚ªãƒ¼ãƒ—ãƒ³ã€‚\n\n"
    },
    {
      "author": "himorishige",
      "created_at": "2022-02-04",
      "body_markdown": "ã•ã‚‰ã«èª¿ã¹ãŸæ„Ÿã˜ä¸‹è¨˜`getDocumentHeaders`ã§å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã€‚\nã“ã“ã«æ¸¡ã™å‰ã«æ­£ã—ããƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„ã§ãã‚Œã°ã‚ˆã„ã®ã‹ã‚‚ã—ã‚Œãªã„ã€‚\nå¼•ç¶šãèª¿æŸ»ã€‚\n\n```typescript\nfunction getDocumentHeaders(build, matches, routeLoaderResponses, actionResponse) {\n  // matches is [root, child], routeLoaderResponses is [child]\n  return matches.reduce((parentHeaders, match, index) => {\n    // index 0, routeModule is root\n    let routeModule = build.routes[match.route.id].module;\n    // index 0, response is from child (since I don't have a root loader)\n    let loaderHeaders = routeLoaderResponses[index] ? routeLoaderResponses[index].headers : new Headers();\n    let actionHeaders = actionResponse ? actionResponse.headers : new Headers();\n    // since root doesn't export headers, i end up with undefined and lose my headers :(\n    let headers = new Headers(routeModule.headers ? typeof routeModule.headers === \"function\" ? routeModule.headers({\n      loaderHeaders,\n      parentHeaders,\n      actionHeaders\n    }) : routeModule.headers : undefined);\n    // Automatically preserve Set-Cookie headers that were set either by the\n    // loader or by a parent route.\n    prependCookies(actionHeaders, headers);\n    prependCookies(loaderHeaders, headers);\n    prependCookies(parentHeaders, headers);\n    return headers;\n  }, new Headers());\n}\n```"
    },
    {
      "author": "himorishige",
      "created_at": "2022-02-11",
      "body_markdown": "ä¿®æ­£ã—ã¦ãã‚ŒãŸğŸ™\nhttps://github.com/remix-run/remix/pull/1847",
      "body_updated_at": "2022-02-11"
    }
  ]
}